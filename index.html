<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PTAR Nexus V1 | Library Smart Digital Process</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              nexus: {
                dark: '#0f172a',
                purple: '#6d28d9',
                glass: 'rgba(255, 255, 255, 0.1)',
                glassBorder: 'rgba(255, 255, 255, 0.2)',
              }
            },
            animation: {
              'scan': 'scan 2s linear infinite',
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'bounce-slow': 'bounce 3s infinite',
            },
            keyframes: {
              scan: {
                '0%': { top: '0%' },
                '100%': { top: '100%' },
              },
              fadeIn: {
                '0%': { opacity: '0', transform: 'translateY(-10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              slideUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      /* Custom Scrollbar hide */
      .scrollbar-hide::-webkit-scrollbar {
          display: none;
      }
      .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      /* Height fix for mobile browsers */
      .h-dvh {
        height: 100vh;
        height: 100dvh;
      }
      .perspective-1000 {
        perspective: 1000px;
      }
      .transform-style-3d {
        transform-style: preserve-3d;
      }
      .backface-hidden {
        backface-visibility: hidden;
      }
      .rotate-y-180 {
        transform: rotateY(180deg);
      }
    </style>
</head>
<body class="bg-slate-50 dark:bg-nexus-dark transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Utils ---
        const getMalaysiaTime = () => {
             return new Date().toLocaleTimeString('en-MY', {
                 timeZone: 'Asia/Kuala_Lumpur',
                 hour: '2-digit',
                 minute: '2-digit',
                 hour12: true
             });
        };

        const getMalaysiaDate = (dateObj = new Date()) => {
             return dateObj.toLocaleDateString('en-MY', {
                 timeZone: 'Asia/Kuala_Lumpur',
                 year: 'numeric',
                 month: 'long',
                 day: 'numeric'
             });
        };
        
        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };

        // --- Mock Data & Constants ---
        
        const studentDatabase = {
          "2024441674": "AFFIE HAFIZAN KHAN BIN ALIJAN KHAN",
          "2024442374": "AMIRA SYAHAIREEN BINTI SAHDAN",
          "2024267258": "ANDRYSHA NYCHELLE ANAK ANDREW",
          "2024427454": "ARSYAD ZULHUSMI BIN KADAI",
          "2024298694": "BIJANI ANAK BAKAR",
          "2024436676": "CASYLVIA ANN ANAK ARMSTRONG",
          "2024436998": "DEAN DE DVINE JITEK",
          "2024206888": "DELLIA SUNGGAU ANAK DONNY",
          "2024670846": "EDIANA ANAK KAMIL",
          "2024223492": "ESTER AWANG",
          "2024288588": "FERGUSON QIUN ANAK LUTA",
          "2024212352": "HANIS YASMIN BINTI HARDYNORHAN",
          "2024419286": "HASNA NAZIRA BINTI AHMAD ROSALLAN",
          "2024204868": "HAZEL ANAK RITCHIE",
          "2024229294": "JAYCARLSON WILSON",
          "2024206946": "LUQMAN NURHAKIM OMARSHARIFF",
          "2024419516": "MOHAMAD ZAINORAZIEM BIN ZAINAL",
          "2024436008": "MOHAMMAD SYAHRIL AZLIE",
          "2024681454": "MOHD AMIRUL HAFIZ BIN ILAH",
          "2024282012": "MUHAMAD HAZIM AKMAL BIN JAMAN",
          "2024411696": "MUHAMMAD AFIQ HAIQAL BIN MOHD ROSDI",
          "2024645246": "NA'IM ANIQ BIN BASRI",
          "2024299084": "NUR AYUNI BINTI SEPAWI",
          "2024244202": "NUR QAMARINA BINTI UZILA",
          "2024200648": "NUR SYAZA ADRIANA BINTI HASMAN",
          "2024427272": "NURFARAH AININ SOFIYA BINTI MAJELAN",
          "2024207026": "NURUL FARAHANA BINTI ABDULLAH",
          "2024223252": "NURUL FATIHAH",
          "2024433328": "REBECCA RUDANG ANAK TIMOTHY",
          "2024604928": "REUBEN JAMES DEALWIS",
          "2024236022": "SITI ZAHIDAH BINTI MOHD RONIE",
          "2024696532": "WAHDANIA AYUMIE ANATASYA"
        };

        const ResourceType = {
          PHYSICAL: 'Physical Book',
          EBOOK: 'E-Book',
          THESIS: 'Thesis (IR)',
          JOURNAL: 'e-Journal',
          PAPER: 'Exam Paper (EQPS)',
          DATABASE: 'Online Database'
        };

        const Genre = {
            ALL: 'All Resources',
            TECH: 'Technology',
            BUSINESS: 'Business',
            FICTION: 'Fiction',
            SCIENCE: 'Science',
            HISTORY: 'History'
        };

        const localPhysicalInventory = [
            {
              id: 'local_1',
              title: 'Management of Digital Transformation',
              author: 'Dr. Marlita Mad Yusuf',
              year: 2024,
              type: ResourceType.PHYSICAL,
              genre: Genre.BUSINESS,
              shelfLocation: 'Level 2, Aisle 4, Shelf B',
              callNumber: 'HD30.2 .M37 2024',
              availability: 'Available',
              coverImage: 'https://picsum.photos/150/220?random=1',
              summary: 'A comprehensive guide on navigating the complexities of digital transformation in modern organizations.'
            },
            {
              id: 'local_5',
              title: 'Clean Code: A Handbook of Agile Software Craftsmanship',
              author: 'Robert C. Martin',
              year: 2008,
              type: ResourceType.PHYSICAL,
              genre: Genre.TECH,
              shelfLocation: 'Level 3, Aisle 1, Shelf A',
              callNumber: 'QA76.76 .C65 M37',
              availability: 'On Loan',
              coverImage: 'https://covers.openlibrary.org/b/isbn/9780132350884-M.jpg',
              summary: 'A must-read for software developers, this book presents best practices for writing clean, maintainable, and readable code.'
            },
            {
              id: 'local_9',
              title: 'Modern Operating Systems',
              author: 'Andrew S. Tanenbaum',
              year: 2014,
              type: ResourceType.PHYSICAL,
              genre: Genre.TECH,
              shelfLocation: 'Level 2, Aisle 10, Shelf D',
              callNumber: 'QA76.76 .O63 T36',
              availability: 'Available',
              coverImage: 'https://covers.openlibrary.org/b/isbn/9780133591620-M.jpg',
              summary: 'A detailed look at operating system concepts, including processes, memory management, file systems, and security.'
            },
            {
              id: 'local_11',
              title: 'Malaysian Economy: Past, Present & Future',
              author: 'Prof. Jomo K.S.',
              year: 2020,
              type: ResourceType.PHYSICAL,
              genre: Genre.BUSINESS,
              shelfLocation: 'Level 1, Aisle 2, Shelf F',
              callNumber: 'HC445.5 .J66 2020',
              availability: 'Available',
              coverImage: 'https://picsum.photos/150/220?random=11',
              summary: 'An economic analysis of Malaysia\'s development journey.'
            },
            {
              id: 'local_14',
              title: 'Artificial Intelligence: A Modern Approach',
              author: 'Stuart Russell',
              year: 2020,
              type: ResourceType.PHYSICAL,
              genre: Genre.TECH,
              shelfLocation: 'Level 4, Aisle 12',
              callNumber: 'Q335 .R86 2020',
              availability: 'Available',
              coverImage: 'https://covers.openlibrary.org/b/isbn/9780134610993-M.jpg',
              summary: 'The leading textbook in AI, providing a comprehensive overview of the field.'
            },
            {
              id: 'local_20',
              title: 'Harry Potter and the Philosopher\'s Stone',
              author: 'J.K. Rowling',
              year: 1997,
              type: ResourceType.PHYSICAL,
              genre: Genre.FICTION,
              shelfLocation: 'Level 1, Fiction Section',
              callNumber: 'PR6068 .O93 H37',
              availability: 'Available',
              coverImage: 'https://covers.openlibrary.org/b/isbn/9780747532743-M.jpg',
              summary: 'The first novel in the Harry Potter series.'
            }
        ];

        const localDigitalInventory = [
            {
                id: 'db_1',
                title: 'IEEE Xplore Digital Library',
                author: 'IEEE',
                year: '2024',
                type: ResourceType.DATABASE,
                genre: Genre.TECH,
                availability: 'PTAR Digital',
                coverImage: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/IEEE_logo.svg/300px-IEEE_logo.svg.png',
                summary: 'Access to over 5 million documents from IEEE journals, conferences, and standards in electrical engineering, computer science, and electronics.',
                url: 'https://ieeexplore.ieee.org/'
            },
            {
                id: 'db_2',
                title: 'ScienceDirect (Elsevier)',
                author: 'Elsevier',
                year: '2024',
                type: ResourceType.DATABASE,
                genre: Genre.SCIENCE,
                availability: 'PTAR Digital',
                coverImage: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/ScienceDirect_logo.svg/300px-ScienceDirect_logo.svg.png',
                summary: 'Leading full-text scientific database offering journal articles and book chapters from more than 2,500 peer-reviewed journals.',
                url: 'https://www.sciencedirect.com/'
            },
            {
                id: 'db_3',
                title: 'Emerald Insight',
                author: 'Emerald Publishing',
                year: '2024',
                type: ResourceType.DATABASE,
                genre: Genre.BUSINESS,
                availability: 'PTAR Digital',
                coverImage: 'https://upload.wikimedia.org/wikipedia/en/thumb/0/00/Emerald_Publishing.svg/300px-Emerald_Publishing.svg.png',
                summary: 'Discover research in business, management, economics, engineering, computing, and social sciences.',
                url: 'https://www.emerald.com/insight/'
            },
            {
                id: 'db_4',
                title: 'ProQuest Dissertations & Theses',
                author: 'ProQuest',
                year: '2024',
                type: ResourceType.THESIS,
                genre: Genre.ALL,
                availability: 'PTAR Digital',
                coverImage: 'https://upload.wikimedia.org/wikipedia/commons/4/41/ProQuest.svg',
                summary: 'The world\'s most comprehensive collection of dissertations and theses from around the world.',
                url: 'https://www.proquest.com/'
            },
            {
                id: 'db_5',
                title: 'ACM Digital Library',
                author: 'Association for Computing Machinery',
                year: '2024',
                type: ResourceType.DATABASE,
                genre: Genre.TECH,
                availability: 'PTAR Digital',
                coverImage: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Association_for_Computing_Machinery_%28ACM%29_logo.svg/300px-Association_for_Computing_Machinery_%28ACM%29_logo.svg.png',
                summary: 'Comprehensive collection of full-text articles and bibliographic records covering the fields of computing and information technology.',
                url: 'https://dl.acm.org/'
            },
            {
                id: 'db_6',
                title: 'SpringerLink',
                author: 'Springer Nature',
                year: '2024',
                type: ResourceType.DATABASE,
                genre: Genre.SCIENCE,
                availability: 'PTAR Digital',
                coverImage: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Springer_Nature.svg/300px-Springer_Nature.svg.png',
                summary: 'Providing researchers with access to millions of scientific documents from journals, books, series, protocols, reference works and proceedings.',
                url: 'https://link.springer.com/'
            },
            {
                id: 'db_7',
                title: 'BLIS (Bernama Library & Infolink Service)',
                author: 'Bernama',
                year: '2024',
                type: ResourceType.DATABASE,
                genre: Genre.HISTORY,
                availability: 'PTAR Digital',
                coverImage: 'https://img.freepik.com/premium-vector/news-logo-design-template-vector_9850-255.jpg',
                summary: 'Comprehensive news and information database on Malaysia, including news archives, biographies, and industry reports.',
                url: 'http://blis.bernama.com/'
            },
            {
                id: 'db_8',
                title: 'LawNet',
                author: 'PNMB',
                year: '2024',
                type: ResourceType.DATABASE,
                genre: Genre.BUSINESS,
                availability: 'PTAR Digital',
                coverImage: 'https://www.lawnet.com.my/lawnetpublic/images/Lawnet_Logo.png',
                summary: 'The authoritative source for Malaysian laws, court judgments, and legal information.',
                url: 'https://www.lawnet.com.my/'
            }
        ];

        // --- Components ---

        // --- Digital ID Component ---
        const DigitalID = ({ user }) => {
            const [flipped, setFlipped] = useState(false);
            const [kioskStatus, setKioskStatus] = useState('Standby'); // Standby, Scanning, Verified

            if (!user) return null;
            
            // Generate QR Code URL based on student ID
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${user.studentId}`;

            const handleKioskScan = () => {
                if (kioskStatus === 'Verified') return;
                setKioskStatus('Scanning');
                // Auto flip to back for scan simulation
                setFlipped(true);
                setTimeout(() => {
                    setKioskStatus('Verified');
                    setTimeout(() => setKioskStatus('Standby'), 3000);
                }, 1500);
            };

            return (
                <div className="flex flex-col gap-4">
                    <div 
                        className="relative w-full h-56 md:h-64 perspective-1000 cursor-pointer group select-none"
                        onClick={() => setFlipped(!flipped)}
                    >
                        <div className={`relative w-full h-full transition-transform duration-700 transform-style-3d ${flipped ? 'rotate-y-180' : ''}`}>
                            
                            {/* Front Side */}
                            <div className="absolute w-full h-full bg-gradient-to-br from-purple-800 to-indigo-900 rounded-2xl p-6 text-white shadow-2xl backface-hidden flex flex-col justify-between overflow-hidden border border-white/10">
                                {/* Abstract Shapes */}
                                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                                <div className="absolute bottom-0 left-0 w-40 h-40 bg-purple-500/20 rounded-full blur-3xl -ml-10 -mb-10"></div>
                                
                                <div className="flex justify-between items-start z-10">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center border border-white/30">
                                            <i className="fa-solid fa-layer-group text-2xl"></i>
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-lg tracking-wide">PTAR NEXUS</h3>
                                            <p className="text-[10px] text-white/70 uppercase tracking-widest">Digital Access Card</p>
                                        </div>
                                    </div>
                                    {/* Removed UiTM Logo as requested */}
                                </div>

                                <div className="flex gap-4 items-center z-10 mt-2">
                                    <div className="w-20 h-20 rounded-xl overflow-hidden border-2 border-white/30 shadow-lg">
                                        <img src={user.avatarUrl} alt="User" className="w-full h-full object-cover" />
                                    </div>
                                    <div>
                                        <h2 className="text-xl font-bold truncate max-w-[180px] md:max-w-xs">{user.name}</h2>
                                        <p className="font-mono text-purple-200 tracking-wider text-sm">{user.studentId}</p>
                                        <div className="mt-1 inline-block px-2 py-0.5 bg-green-500/20 border border-green-400/30 rounded text-[10px] font-semibold text-green-300">
                                            ACTIVE STUDENT
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-between items-end z-10">
                                    <div>
                                        <p className="text-[9px] text-white/50 uppercase">Faculty</p>
                                        <p className="text-xs font-medium truncate max-w-[200px]">{user.department}</p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] text-white/50">Tap to Scan</span>
                                        <i className="fa-solid fa-qrcode text-white text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            {/* Back Side */}
                            <div className="absolute w-full h-full bg-slate-100 rounded-2xl p-6 text-slate-800 shadow-2xl backface-hidden rotate-y-180 flex flex-col items-center justify-center border border-slate-300">
                                {/* Removed Black Strip as requested */}
                                
                                <div className="mt-4 text-center w-full flex flex-col items-center">
                                    <p className="text-xs font-bold text-slate-500 mb-3 uppercase tracking-widest">Library Entry Pass</p>
                                    
                                    {/* QR Code Display */}
                                    <div className="bg-white p-2 rounded-xl shadow-lg border border-slate-200 mb-3">
                                        <img src={qrCodeUrl} alt="Entry QR Code" className="w-32 h-32 object-contain" />
                                    </div>
                                    
                                    <div className="bg-slate-200 px-4 py-1.5 rounded-lg border border-slate-300">
                                        <p className="font-mono text-lg tracking-widest font-bold text-slate-700">{user.studentId}</p>
                                    </div>
                                </div>
                                
                                <div className="mt-auto w-full flex justify-between items-center text-[10px] text-slate-400">
                                    <span>Valid until: Dec 2025</span>
                                    <span><i className="fa-solid fa-rotate mr-1"></i> Flip back</span>
                                </div>
                            </div>

                        </div>
                    </div>

                    {/* Digital Kiosk Section */}
                    <div className="bg-white/60 dark:bg-white/5 backdrop-blur-md border border-slate-200 dark:border-white/10 rounded-2xl p-4 flex items-center justify-between shadow-lg">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center border-2 ${
                                kioskStatus === 'Verified' ? 'bg-green-100 border-green-500 text-green-600' :
                                kioskStatus === 'Scanning' ? 'bg-yellow-100 border-yellow-500 text-yellow-600 animate-pulse' :
                                'bg-slate-100 dark:bg-white/10 border-slate-300 dark:border-white/20 text-slate-400'
                            }`}>
                                <i className={`fa-solid ${
                                    kioskStatus === 'Verified' ? 'fa-check' :
                                    kioskStatus === 'Scanning' ? 'fa-wifi' :
                                    'fa-door-open'
                                }`}></i>
                            </div>
                            <div>
                                <h4 className="font-bold text-sm text-slate-800 dark:text-white">Entry Kiosk</h4>
                                <p className="text-[10px] text-slate-500 dark:text-gray-400">
                                    {kioskStatus === 'Verified' ? 'Access Granted' : 
                                     kioskStatus === 'Scanning' ? 'Verifying ID...' : 
                                     'Tap to Check-in'}
                                </p>
                            </div>
                        </div>
                        <button 
                            onClick={handleKioskScan}
                            disabled={kioskStatus !== 'Standby'}
                            className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                kioskStatus === 'Verified' ? 'bg-green-500 text-white' :
                                kioskStatus === 'Scanning' ? 'bg-yellow-500 text-white' :
                                'bg-purple-600 hover:bg-purple-500 text-white'
                            }`}
                        >
                            {kioskStatus === 'Verified' ? 'OPEN' : 'SCAN'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Room Booking Component ---
        const RoomBooking = ({ onBookClick, rooms }) => {
            return (
                <div className="bg-white/60 dark:bg-white/5 backdrop-blur-md border border-slate-200 dark:border-white/10 rounded-2xl p-5 shadow-xl transition-colors h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <i className="fa-solid fa-people-roof text-purple-500"></i> Smart Rooms
                        </h3>
                        <span className="text-xs px-2 py-1 bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-300 rounded-lg animate-pulse">
                            Live Status
                        </span>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto pr-1 scrollbar-hide flex-1">
                        {rooms.map((room) => (
                            <div 
                                key={room.id}
                                onClick={() => room.status === 'Available' && onBookClick(room)}
                                className={`p-4 rounded-xl border transition-all duration-300 relative group ${
                                    room.status === 'Available'
                                    ? 'bg-white dark:bg-white/5 border-slate-200 dark:border-white/10 hover:border-purple-500 cursor-pointer hover:shadow-lg hover:-translate-y-1'
                                    : 'bg-slate-50 dark:bg-black/20 border-slate-100 dark:border-white/5 opacity-80 cursor-not-allowed'
                                }`}
                            >
                                <div className="flex justify-between items-start mb-2">
                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                                        room.status === 'Available' 
                                        ? 'bg-purple-100 dark:bg-purple-500/20 text-purple-600 dark:text-purple-300' 
                                        : 'bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-gray-400'
                                    }`}>
                                        <i className="fa-solid fa-chalkboard-user"></i>
                                    </div>
                                    <div className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${
                                        room.status === 'Available' 
                                        ? 'bg-green-100 dark:bg-green-500/20 text-green-600 dark:text-green-300' 
                                        : room.status === 'Occupied' 
                                            ? 'bg-red-100 dark:bg-red-500/20 text-red-600 dark:text-red-300'
                                            : 'bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-gray-300'
                                    }`}>
                                        {room.status}
                                    </div>
                                </div>
                                
                                <h4 className="font-bold text-sm text-slate-800 dark:text-white mb-0.5">{room.name}</h4>
                                <p className="text-[10px] text-slate-500 dark:text-gray-400 mb-3">{room.capacity} Pax Capacity</p>

                                <div className="flex items-center gap-1 text-[10px] text-slate-400 dark:text-gray-500 border-t border-slate-100 dark:border-white/5 pt-2">
                                    <i className="fa-regular fa-clock"></i>
                                    {room.status === 'Available' ? 'Ready for booking' : `Next: ${room.nextAvailable}`}
                                </div>

                                {room.status === 'Available' && (
                                    <div className="absolute inset-0 bg-purple-600/90 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <span className="text-white font-bold text-sm"><i className="fa-regular fa-calendar-check mr-1"></i> Book Now</span>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Analytics Component ---
        const Analytics = () => {
            const [data, setData] = useState([]);

            useEffect(() => {
                // Fixed Genres per user request
                const baseGenres = [
                    { name: 'Sci-Fi', color: 'bg-gradient-to-t from-purple-600 to-purple-400' },
                    { name: 'History', color: 'bg-gradient-to-t from-green-600 to-green-400' },
                    { name: 'Tech', color: 'bg-gradient-to-t from-yellow-500 to-yellow-300' },
                    { name: 'Biz', color: 'bg-gradient-to-t from-orange-500 to-orange-300' },
                ];
                
                // Randomize values only for "Live" effect
                const randomized = baseGenres.map(item => ({
                    ...item,
                    value: Math.floor(Math.random() * 500) + 150 // Ensure minimum height
                }));
                setData(randomized);
            }, []);

            return (
                 <div className="bg-white/60 dark:bg-white/5 backdrop-blur-md border border-slate-200 dark:border-white/10 rounded-2xl p-5 shadow-xl transition-colors h-full flex flex-col min-h-[350px]">
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2">
                        <i className="fa-solid fa-chart-pie text-pink-500"></i> Trending Genres (Live)
                    </h3>
                    
                    <div className="flex-1 flex flex-col justify-end gap-2 pb-4">
                        <div className="flex items-end justify-around h-48 px-2 gap-4">
                            {data.map((item, idx) => (
                                <div key={idx} className="flex flex-col items-center gap-3 w-full group h-full justify-end">
                                    <div className="w-full relative flex items-end h-full">
                                        <div 
                                            className={`w-full rounded-t-xl transition-all duration-1000 ease-out shadow-lg ${item.color}`} 
                                            style={{ height: `${(item.value / 650) * 100}%` }}
                                        >
                                            <div className="w-full h-full bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity rounded-t-xl"></div>
                                        </div>
                                    </div>
                                    <div className="text-center">
                                        <span className="block text-xs font-bold text-slate-700 dark:text-white">{item.name}</span>
                                        <span className="block text-[10px] text-slate-500 dark:text-gray-400">{item.value} reads</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="mt-auto pt-4 border-t border-slate-200 dark:border-white/10">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs text-slate-500 dark:text-gray-400">Monthly Target</span>
                            <span className="text-xs font-bold text-slate-800 dark:text-white">85%</span>
                        </div>
                        <div className="w-full bg-slate-200 dark:bg-white/10 rounded-full h-2.5 overflow-hidden">
                            <div className="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 h-full rounded-full animate-pulse" style={{ width: '85%' }}></div>
                        </div>
                    </div>
                </div>
            );
        };


        // --- User Profile Modal ---
        const UserProfileModal = ({ user, isOpen, onClose, history }) => {
            if (!isOpen || !user) return null;

            // Mock Data for Analytics
            const analytics = {
                loginFrequency: "Daily (Avg 3 logins/day)",
                peakTime: "02:00 PM - 04:00 PM",
                topSearch: ["Clean Code", "Digital Economy", "Management 101"],
                resourceMix: [
                    { label: "Physical Books", val: 35, color: "bg-amber-500" },
                    { label: "E-Journals", val: 45, color: "bg-purple-500" },
                    { label: "Databases", val: 20, color: "bg-cyan-500" }
                ]
            };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-3xl w-full max-w-4xl shadow-2xl flex flex-col md:flex-row overflow-hidden animate-slide-up transition-colors max-h-[90vh]">
                        
                        {/* Sidebar / Bio */}
                        <div className="w-full md:w-1/3 bg-slate-50 dark:bg-black/20 p-8 flex flex-col items-center border-r border-slate-200 dark:border-white/10 text-center">
                             <div className="w-24 h-24 md:w-32 md:h-32 rounded-full border-4 border-purple-500 shadow-xl mb-4 overflow-hidden">
                                <img src={user.avatarUrl} alt={user.name} className="w-full h-full object-cover" />
                             </div>
                             <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-1">{user.name}</h2>
                             <p className="text-sm text-purple-600 dark:text-purple-400 font-mono mb-4">{user.studentId}</p>
                             
                             <div className="w-full text-left space-y-3 mt-4">
                                <div className="bg-white dark:bg-white/5 p-3 rounded-xl border border-slate-200 dark:border-white/5">
                                    <p className="text-xs text-slate-500 dark:text-gray-400 uppercase font-bold">Faculty</p>
                                    <p className="text-sm font-semibold text-slate-700 dark:text-gray-200">{user.department}</p>
                                </div>
                                <div className="bg-white dark:bg-white/5 p-3 rounded-xl border border-slate-200 dark:border-white/5">
                                    <p className="text-xs text-slate-500 dark:text-gray-400 uppercase font-bold">Email</p>
                                    <p className="text-sm font-semibold text-slate-700 dark:text-gray-200 truncate">{user.studentId}@student.uitm.edu.my</p>
                                </div>
                                <div className="bg-white dark:bg-white/5 p-3 rounded-xl border border-slate-200 dark:border-white/5">
                                    <p className="text-xs text-slate-500 dark:text-gray-400 uppercase font-bold">Status</p>
                                    <p className="text-sm font-semibold text-green-600 dark:text-green-400 flex items-center gap-2">
                                        <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Active Student
                                    </p>
                                </div>
                             </div>
                        </div>

                        {/* Content / Stats */}
                        <div className="flex-1 p-8 overflow-y-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                    <i className="fa-solid fa-chart-user text-cyan-500"></i> Student Analytics
                                </h3>
                                <button onClick={onClose} className="w-8 h-8 rounded-full bg-slate-200 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 flex items-center justify-center transition-colors">
                                    <i className="fa-solid fa-xmark text-slate-600 dark:text-white"></i>
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div className="p-4 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 border border-indigo-500/20 rounded-2xl">
                                    <p className="text-xs text-indigo-600 dark:text-indigo-300 font-bold uppercase mb-1">Login Frequency</p>
                                    <p className="text-lg font-bold text-slate-800 dark:text-white">{analytics.loginFrequency}</p>
                                </div>
                                <div className="p-4 bg-gradient-to-br from-pink-500/10 to-rose-500/10 border border-pink-500/20 rounded-2xl">
                                    <p className="text-xs text-pink-600 dark:text-pink-300 font-bold uppercase mb-1">Peak Usage Time</p>
                                    <p className="text-lg font-bold text-slate-800 dark:text-white">{analytics.peakTime}</p>
                                </div>
                            </div>

                            <div className="mb-6">
                                <h4 className="text-sm font-bold text-slate-700 dark:text-gray-300 mb-3">Resource Usage Patterns</h4>
                                <div className="flex h-4 rounded-full overflow-hidden mb-2">
                                    {analytics.resourceMix.map((item, idx) => (
                                        <div key={idx} className={`${item.color} h-full`} style={{width: `${item.val}%`}}></div>
                                    ))}
                                </div>
                                <div className="flex gap-4 text-xs">
                                    {analytics.resourceMix.map((item, idx) => (
                                        <div key={idx} className="flex items-center gap-1">
                                            <div className={`w-2 h-2 rounded-full ${item.color}`}></div>
                                            <span className="text-slate-500 dark:text-gray-400">{item.label} ({item.val}%)</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h4 className="text-sm font-bold text-slate-700 dark:text-gray-300 mb-3">Recent Search Queries</h4>
                                <div className="flex flex-wrap gap-2 mb-6">
                                    {analytics.topSearch.map((term, idx) => (
                                        <span key={idx} className="px-3 py-1 bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-full text-xs text-slate-600 dark:text-gray-300">
                                            <i className="fa-solid fa-magnifying-glass mr-1 opacity-50"></i> {term}
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {/* Added Activity History Section */}
                            <div>
                                <h4 className="text-sm font-bold text-slate-700 dark:text-gray-300 mb-3">Activity History (Reading, Borrowing, Returns)</h4>
                                <div className="bg-slate-50 dark:bg-white/5 rounded-xl p-4 border border-slate-200 dark:border-white/5 max-h-48 overflow-y-auto scrollbar-hide">
                                    {history && history.length > 0 ? (
                                        history.map((item, idx) => (
                                            <div key={idx} className="flex items-start gap-3 mb-3 last:mb-0 border-b border-slate-200 dark:border-white/5 pb-2 last:border-0 last:pb-0">
                                                <div className="mt-1 w-2 h-2 rounded-full bg-purple-500 flex-shrink-0"></div>
                                                <div>
                                                    <p className="text-xs text-slate-700 dark:text-gray-300 font-medium">{item.message}</p>
                                                    <p className="text-[10px] text-slate-400 dark:text-gray-500">{item.time}</p>
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-xs text-slate-400 text-center py-4">No recent activity recorded.</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- Loan Registration Form Modal ---
        const LoanFormModal = ({ book, user, isOpen, onClose, onConfirm, mode = 'BORROW' }) => {
             const [courseCode, setCourseCode] = useState('');
             const [errorMsg, setErrorMsg] = useState('');
             const today = new Date();
             
             // Calculate dates
             const borrowDate = getMalaysiaDate(today);
             // Return date: If Renew, +7 days. If Borrow, +14 days.
             const daysToAdd = mode === 'RENEW' ? 7 : 14;
             const returnDateObj = addDays(today, daysToAdd);
             const returnDate = getMalaysiaDate(returnDateObj);
             const returnTime = "5:00 PM"; // Fixed library closing time

             if (!isOpen || !book) return null;

             const handleConfirm = () => {
                 setErrorMsg('');
                 // For Renewal, course code is optional. For Borrowing, it's required.
                 if (mode === 'BORROW' && !courseCode.trim()) {
                     setErrorMsg("Please enter your Course Code to proceed.");
                     return;
                 }
                 
                 onConfirm({
                     bookId: book.id,
                     courseCode: courseCode || 'N/A', // Default if renewal
                     borrowDate,
                     returnDate,
                     mode
                 });
             };

             return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-2xl w-full max-w-lg shadow-2xl flex flex-col animate-slide-up transition-colors">
                        
                        <div className="p-5 border-b border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-slate-800/50 rounded-t-2xl flex justify-between items-center">
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">
                                {mode === 'RENEW' ? 'Renew Loan' : 'Borrowing Registration'}
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-white">
                                <i className="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        <div className="p-6 space-y-4">
                            <div className="bg-slate-100 dark:bg-white/5 p-4 rounded-xl border border-slate-200 dark:border-white/5 flex gap-4 items-center">
                                <div className="w-16 h-24 bg-slate-200 dark:bg-black/30 rounded-lg overflow-hidden flex-shrink-0">
                                     {book.coverImage !== 'placeholder' ? (
                                        <img src={book.coverImage} className="w-full h-full object-cover" />
                                     ) : (
                                        <div className="w-full h-full flex items-center justify-center"><i className="fa-solid fa-book text-gray-400"></i></div>
                                     )}
                                </div>
                                <div>
                                    <p className="text-xs text-slate-500 dark:text-gray-400 uppercase font-bold">{book.type}</p>
                                    <h4 className="font-bold text-slate-900 dark:text-white leading-tight">{book.title}</h4>
                                    <p className="text-xs text-slate-500 dark:text-gray-400 mt-1">{book.author}</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-1">FULL NAME</label>
                                    <input type="text" value={user.name} readOnly className="w-full bg-slate-100 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-700 dark:text-gray-300" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-1">STUDENT ID</label>
                                    <input type="text" value={user.studentId} readOnly className="w-full bg-slate-100 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-700 dark:text-gray-300" />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-1">
                                    COURSE CODE {mode === 'BORROW' && <span className="text-red-500">*</span>}
                                </label>
                                <input 
                                    type="text" 
                                    value={courseCode}
                                    onChange={(e) => {
                                        setCourseCode(e.target.value.toUpperCase());
                                        setErrorMsg('');
                                    }}
                                    placeholder={mode === 'RENEW' ? "Optional for renewal" : "e.g. CS240"}
                                    className="w-full bg-white dark:bg-black/40 border border-slate-300 dark:border-white/20 rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:border-purple-500 transition-colors uppercase" 
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-1">BORROWING DATE</label>
                                    <div className="w-full bg-slate-100 dark:bg-black/20 border border-slate-200 dark:border-white/10 rounded-lg px-3 py-2 text-sm text-slate-700 dark:text-gray-300 flex items-center gap-2">
                                        <i className="fa-regular fa-calendar text-slate-400"></i> {borrowDate}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-1">
                                        {mode === 'RENEW' ? 'NEW DUE DATE' : 'RETURNING DATE'}
                                    </label>
                                    {mode === 'RENEW' ? (
                                        <div className="w-full rounded-lg px-2 py-2 text-sm flex items-center justify-between gap-1 font-bold bg-blue-100 dark:bg-blue-600/20 border-2 border-blue-400 dark:border-blue-500 text-blue-800 dark:text-blue-200 shadow-md">
                                            <div className="flex items-center gap-1.5">
                                                <i className="fa-solid fa-calendar-plus text-blue-600 dark:text-blue-300"></i>
                                                <div className="flex flex-col leading-none">
                                                    <span>{returnDate}</span>
                                                    <span className="text-[10px] font-normal opacity-80">by {returnTime}</span>
                                                </div>
                                            </div>
                                            <span className="text-[9px] bg-blue-600 text-white px-1.5 py-0.5 rounded-full font-extrabold">+7 DAYS</span>
                                        </div>
                                    ) : (
                                        <div className="w-full rounded-lg px-3 py-2 text-sm flex items-center gap-2 font-bold bg-green-50 dark:bg-green-500/10 border border-green-200 dark:border-green-500/20 text-green-700 dark:text-green-300">
                                            <i className="fa-solid fa-calendar-check"></i> {returnDate}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {mode === 'RENEW' && (
                                <div className="text-xs text-blue-600 dark:text-blue-300 bg-blue-50 dark:bg-blue-500/10 p-3 rounded-lg border border-blue-100 dark:border-blue-500/20">
                                    <i className="fa-solid fa-circle-info mr-1"></i>
                                    Renewal extends your loan period by 7 days from today. Late fines may still apply if already overdue.
                                </div>
                            )}

                            {errorMsg && (
                                <div className="text-xs text-red-600 dark:text-red-300 bg-red-50 dark:bg-red-500/10 p-3 rounded-lg border border-red-100 dark:border-red-500/20 animate-pulse">
                                    <i className="fa-solid fa-circle-exclamation mr-1"></i> {errorMsg}
                                </div>
                            )}
                        </div>

                        <div className="p-5 border-t border-slate-200 dark:border-white/10 flex gap-3">
                             <button onClick={onClose} className="flex-1 py-2.5 rounded-xl text-slate-600 dark:text-gray-300 font-medium hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">Cancel</button>
                             <button onClick={handleConfirm} className="flex-1 py-2.5 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold shadow-lg shadow-purple-900/20 transition-all">
                                 {mode === 'RENEW' ? 'Confirm Renewal' : 'Confirm Registration'}
                             </button>
                        </div>
                    </div>
                </div>
             );
        };

        // --- 1. Chatbot Component (NexusBot) ---
        const Chatbot = ({ user }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([
                { id: 1, text: `Beep boop! Hi ${user ? user.name.split(' ')[0] : 'friend'}! I'm NexusBot. How can I help you today?`, sender: 'bot' }
            ]);
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);
            const botAvatar = "https://api.dicebear.com/9.x/bottts-neutral/svg?seed=NexusBot&backgroundColor=b6e3f4&eyes=bulging&mouth=smile01";

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages, isOpen]);

            const generateResponse = (text) => {
                const lower = text.toLowerCase();
                if (lower.includes('hour') || lower.includes('open') || lower.includes('time')) {
                    return "PTAR is open from 8:00 AM to 10:00 PM on Weekdays, and 9:00 AM to 5:00 PM on Weekends. Beep!";
                } else if (lower.includes('wifi') || lower.includes('internet')) {
                    return "To connect to WiFi: Use network 'UiTM-Student'. Your Username is your Student ID, and Password is your iStudent password.";
                } else if (lower.includes('book') || lower.includes('room')) {
                    return "You can book discussion rooms using the 'Room Booking' tab in this dashboard. Click 'Book' on an available room.";
                } else if (lower.includes('fine') || lower.includes('late')) {
                    return "Fines for late return are RM0.20 per book per day. You can pay fines at the main counter or via UiTM Pay.";
                } else if (lower.includes('print') || lower.includes('copy')) {
                    return "Printing services are available at Level 1, IT Corner. Rate is RM0.10 per page (B&W).";
                } else if (lower.includes('hello') || lower.includes('hi')) {
                    return "Hello! Beep boop! Is there anything specific you'd like to find today?";
                } else if (lower.includes('renew')) {
                    return "You can renew your borrowed books in the book detail view if they are not overdue or reserved by others.";
                } else {
                    return "I'm still learning! Try asking about 'opening hours', 'booking rooms', 'wifi access', or 'fines'.";
                }
            };

            const handleSend = (e) => {
                e.preventDefault();
                if (!input.trim()) return;

                const userMsg = { id: Date.now(), text: input, sender: 'user' };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setIsTyping(true);

                setTimeout(() => {
                    const responseText = generateResponse(userMsg.text);
                    const botMsg = { id: Date.now() + 1, text: responseText, sender: 'bot' };
                    setMessages(prev => [...prev, botMsg]);
                    setIsTyping(false);
                }, 1000);
            };

            return (
                <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
                    {isOpen && (
                        <div className="mb-4 w-80 md:w-96 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/20 rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col h-[500px] transition-colors">
                            <div className="bg-gradient-to-r from-cyan-600 to-blue-600 p-4 flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center overflow-hidden border-2 border-white/30">
                                        <img src={botAvatar} alt="NexusBot" className="w-full h-full object-cover" />
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-white text-sm">NexusBot</h3>
                                        <p className="text-[10px] text-cyan-200 flex items-center gap-1">
                                            <span className="w-1.5 h-1.5 rounded-full bg-green-400"></span> Online
                                        </p>
                                    </div>
                                </div>
                                <button onClick={() => setIsOpen(false)} className="text-white/70 hover:text-white transition-colors">
                                    <i className="fa-solid fa-xmark"></i>
                                </button>
                            </div>

                            <div className="flex-1 bg-slate-50 dark:bg-nexus-dark/50 p-4 overflow-y-auto scrollbar-hide flex flex-col gap-3 transition-colors">
                                {messages.map((msg) => (
                                    <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] flex items-end gap-2 ${msg.sender === 'user' ? 'flex-row-reverse' : 'flex-row'}`}>
                                            {msg.sender === 'bot' && (
                                                <img src={botAvatar} className="w-6 h-6 rounded-full mb-1" alt="Bot" />
                                            )}
                                            
                                            <div className={`p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${
                                                msg.sender === 'user' 
                                                ? 'bg-cyan-600 text-white rounded-tr-none' 
                                                : 'bg-white dark:bg-white/10 text-slate-800 dark:text-gray-200 rounded-tl-none border border-slate-200 dark:border-white/5'
                                            }`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {isTyping && (
                                    <div className="flex justify-start items-end gap-2">
                                        <img src={botAvatar} className="w-6 h-6 rounded-full mb-1" alt="Bot" />
                                        <div className="bg-white dark:bg-white/10 p-3 rounded-2xl rounded-tl-none border border-slate-200 dark:border-white/5 flex gap-1 shadow-sm">
                                            <span className="w-1.5 h-1.5 bg-gray-500 dark:bg-gray-400 rounded-full animate-bounce"></span>
                                            <span className="w-1.5 h-1.5 bg-gray-500 dark:bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></span>
                                            <span className="w-1.5 h-1.5 bg-gray-500 dark:bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></span>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            <form onSubmit={handleSend} className="p-3 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-white/10 flex gap-2 transition-colors">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Ask NexusBot..."
                                    className="flex-1 bg-slate-100 dark:bg-black/30 border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 text-slate-900 dark:text-white text-sm focus:outline-none focus:border-cyan-500 transition-colors"
                                />
                                <button type="submit" className="w-10 h-10 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white flex items-center justify-center transition-colors shadow-lg shadow-cyan-600/20">
                                    <i className="fa-solid fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    )}

                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className={`w-16 h-16 rounded-full shadow-lg shadow-cyan-600/30 flex items-center justify-center transition-all hover:scale-110 overflow-hidden border-2 border-white/20 ${isOpen ? 'bg-red-500 rotate-90' : 'bg-gradient-to-r from-cyan-600 to-blue-500 animate-bounce-slow'}`}
                    >
                        {isOpen ? (
                            <i className="fa-solid fa-xmark text-white text-2xl"></i>
                        ) : (
                            <img src={botAvatar} alt="Chat" className="w-full h-full object-cover scale-110" />
                        )}
                    </button>
                </div>
            );
        };

        // --- 2. Smart Booking Modal Component ---
        const BookingModal = ({ room, user, isOpen, onClose, onConfirm }) => {
            const [selectedDate, setSelectedDate] = useState('');
            const [selectedTime, setSelectedTime] = useState(null);
            const [purpose, setPurpose] = useState('Discussion');
            
            // Available Time Slots
            const allTimeSlots = [
                '09:00 AM', '10:00 AM', '11:00 AM', '12:00 PM', 
                '02:00 PM', '03:00 PM', '04:00 PM', '05:00 PM'
            ];
            
            const [availableSlots, setAvailableSlots] = useState([]);
            const [occupiedSlots, setOccupiedSlots] = useState([]);

            useEffect(() => {
                if (isOpen) {
                    setSelectedTime(null);
                    // Default to today
                    const today = new Date().toISOString().split('T')[0];
                    setSelectedDate(today);
                }
            }, [isOpen]);

            // Filter slots based on Real-time
            useEffect(() => {
                if (!selectedDate) return;

                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const currentHour = now.getHours();

                // If selected date is today, filter out past hours
                let filteredSlots = allTimeSlots;
                if (selectedDate === todayStr) {
                    filteredSlots = allTimeSlots.filter(slot => {
                        let slotHour = parseInt(slot.split(':')[0]);
                        if (slot.includes('PM') && slotHour !== 12) slotHour += 12;
                        if (slot.includes('AM') && slotHour === 12) slotHour = 0; // midnight edge case, not in list though
                        return slotHour > currentHour;
                    });
                }

                setAvailableSlots(filteredSlots);
                
                // Randomly occupy some of the remaining slots to simulate other students
                // Seed random based on date string so it doesn't flicker
                const seed = selectedDate.split('-').reduce((a,c) => a+parseInt(c), 0);
                const randomOccupied = filteredSlots.filter((_, i) => (seed + i) % 3 === 0);
                setOccupiedSlots(randomOccupied);

            }, [selectedDate, isOpen]);


            const handleDateChange = (e) => {
                setSelectedDate(e.target.value);
                setSelectedTime(null);
            };

            if (!isOpen || !room) return null;

            return (
                 <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-2xl w-full max-w-lg shadow-2xl flex flex-col animate-slide-up transition-colors">
                        
                        <div className="p-5 border-b border-slate-200 dark:border-white/10 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-2xl transition-colors">
                            <div>
                                <h3 className="text-xl font-bold text-slate-900 dark:text-white">{room.name}</h3>
                                <p className="text-xs text-slate-500 dark:text-gray-400">Capacity: {room.capacity} Pax</p>
                            </div>
                            <button onClick={onClose} className="w-8 h-8 rounded-full bg-slate-200 dark:bg-white/5 hover:bg-slate-300 dark:hover:bg-white/10 text-slate-600 dark:text-gray-300 flex items-center justify-center transition-colors">
                                <i className="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        <div className="p-6 space-y-6">
                            
                            <div className="bg-slate-100 dark:bg-white/5 p-3 rounded-xl border border-slate-200 dark:border-white/5 flex items-center gap-3 transition-colors">
                                <div className="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-600/20 flex items-center justify-center text-purple-600 dark:text-purple-300">
                                    <i className="fa-solid fa-user"></i>
                                </div>
                                <div>
                                    <p className="text-xs text-slate-500 dark:text-gray-400">Booking As</p>
                                    <p className="text-sm font-bold text-slate-900 dark:text-white">{user.name}</p>
                                    <p className="text-[10px] text-slate-500 dark:text-gray-400">{user.studentId}</p>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-2">SELECT DATE</label>
                                <input 
                                    type="date" 
                                    value={selectedDate}
                                    onChange={handleDateChange}
                                    min={new Date().toISOString().split('T')[0]}
                                    className="w-full bg-slate-100 dark:bg-black/30 border border-slate-300 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-purple-500 transition-colors"
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-2">AVAILABLE SLOTS</label>
                                {availableSlots.length === 0 ? (
                                    <div className="text-center p-4 bg-slate-100 dark:bg-white/5 rounded-xl text-slate-500 dark:text-gray-500 text-sm">
                                        No slots available for this date/time.
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-4 gap-2">
                                        {availableSlots.map(time => {
                                            const isOccupied = occupiedSlots.includes(time);
                                            const isSelected = selectedTime === time;
                                            return (
                                                <button
                                                    key={time}
                                                    disabled={isOccupied}
                                                    onClick={() => setSelectedTime(time)}
                                                    className={`py-2 rounded-lg text-xs font-medium transition-all ${
                                                        isOccupied 
                                                            ? 'bg-red-500/10 text-red-500/50 cursor-not-allowed border border-transparent'
                                                            : isSelected
                                                                ? 'bg-green-500 text-white dark:text-black shadow-lg shadow-green-500/20 scale-105'
                                                                : 'bg-slate-100 dark:bg-white/5 text-slate-600 dark:text-gray-300 hover:bg-slate-200 dark:hover:bg-white/10 border border-slate-200 dark:border-white/10'
                                                    }`}
                                                >
                                                    {time}
                                                </button>
                                            )
                                        })}
                                    </div>
                                )}
                                <p className="text-[10px] text-slate-500 dark:text-gray-500 mt-2 text-right">
                                    <span className="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>Selected
                                    <span className="inline-block w-2 h-2 rounded-full bg-slate-100 dark:bg-white/10 border border-slate-200 dark:border-white/10 ml-2 mr-1"></span>Available
                                    <span className="inline-block w-2 h-2 rounded-full bg-red-900/50 ml-2 mr-1"></span>Occupied
                                </p>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-slate-500 dark:text-gray-400 mb-2">PURPOSE</label>
                                <div className="relative">
                                    <select 
                                        value={purpose}
                                        onChange={(e) => setPurpose(e.target.value)}
                                        className="w-full bg-slate-100 dark:bg-black/30 border border-slate-300 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-purple-500 appearance-none transition-colors"
                                    >
                                        <option>Group Discussion</option>
                                        <option>Study Session</option>
                                        <option>Project Meeting</option>
                                        <option>Club Activity</option>
                                    </select>
                                    <div className="absolute right-4 top-3.5 text-slate-500 dark:text-gray-400 pointer-events-none">
                                        <i className="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div className="p-5 border-t border-slate-200 dark:border-white/10 flex gap-3 transition-colors">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl text-slate-600 dark:text-gray-300 font-medium hover:bg-slate-100 dark:hover:bg-white/5 transition-colors">
                                Cancel
                            </button>
                            <button 
                                disabled={!selectedTime || !selectedDate}
                                onClick={() => onConfirm({ room, date: selectedDate, time: selectedTime, purpose })}
                                className="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold shadow-lg shadow-purple-900/40 hover:scale-[1.02] active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Confirm Booking
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const BookReader = ({ book, onClose }) => {
            const [currentPage, setCurrentPage] = useState(1);
            const totalPages = 15; // Mock total pages

            // Mock content generation based on Genre
            const getContent = (page) => {
                if (page === 1) return `
                    <div class="text-center mt-20">
                        <h1 class="text-3xl md:text-4xl font-bold mb-4">${book.title}</h1>
                        <p class="text-xl text-gray-500 mb-8">${book.author}</p>
                        <div class="inline-block px-4 py-2 bg-gray-100 rounded-lg text-sm text-gray-600">
                            ${book.genre}  ${book.year}
                        </div>
                        <p class="mt-20 text-sm text-gray-400">Published by PTAR Digital Press</p>
                        ${book.type === ResourceType.PAPER ? '<p class="mt-4 text-red-500 font-bold uppercase border-2 border-red-500 inline-block px-4 py-1 rotate-[-5deg]">Confidential</p>' : ''}
                    </div>
                `;

                // Generic text content
                return `
                    <div class="text-justify leading-relaxed text-lg text-gray-800">
                        <h3 class="text-xl font-bold mb-4">Chapter ${page - 1}</h3>
                        <p class="mb-4">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
                            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                        </p>
                        <p class="mb-4">
                            Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. 
                            Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                        </p>
                        <p class="mb-4">
                            Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, 
                            eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.
                        </p>
                        <div class="p-4 bg-blue-50 border-l-4 border-blue-500 my-6">
                            <p class="text-sm italic text-blue-900">
                                "The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice."
                            </p>
                        </div>
                         <p>
                            Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos 
                            qui ratione voluptatem sequi nesciunt.
                        </p>
                    </div>
                `;
            };

            return (
                <div className="fixed inset-0 z-[100] bg-slate-900 flex flex-col animate-fade-in">
                    {/* Reader Toolbar */}
                    <div className="h-14 bg-slate-800 border-b border-white/10 flex items-center justify-between px-4 shadow-lg flex-shrink-0">
                        <div className="flex items-center gap-3 text-white overflow-hidden">
                            <i className="fa-solid fa-book-open text-purple-400"></i>
                            <span className="font-semibold truncate max-w-[200px] md:max-w-md">{book.title}</span>
                        </div>
                        
                        <div className="flex items-center gap-4">
                             <div className="hidden md:flex items-center bg-black/30 rounded-lg px-3 py-1 text-sm text-gray-300 gap-2">
                                <span>Page {currentPage} of {totalPages}</span>
                             </div>
                             <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 text-white transition-colors">
                                <i className="fa-solid fa-xmark text-lg"></i>
                             </button>
                        </div>
                    </div>

                    {/* Reader Body */}
                    <div className="flex-1 bg-neutral-200 overflow-y-auto p-4 md:p-8 flex justify-center relative">
                        {/* Page Container */}
                        <div className="w-full max-w-3xl bg-white shadow-2xl min-h-[80vh] md:min-h-[120vh] p-8 md:p-16 relative">
                            <div dangerouslySetInnerHTML={{ __html: getContent(currentPage) }}></div>
                            
                            {/* Page Number Footer */}
                            <div className="absolute bottom-6 left-0 w-full text-center text-xs text-gray-400">
                                {currentPage}
                            </div>
                        </div>

                        {/* Navigation Overlay Arrows (Desktop) */}
                        <button 
                            disabled={currentPage === 1}
                            onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                            className={`fixed left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-all ${currentPage === 1 ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}
                        >
                            <i className="fa-solid fa-chevron-left"></i>
                        </button>
                        
                        <button 
                            disabled={currentPage === totalPages}
                            onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                            className={`fixed right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-all ${currentPage === totalPages ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}
                        >
                            <i className="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>

                    {/* Mobile Footer Controls */}
                    <div className="md:hidden h-14 bg-slate-800 border-t border-white/10 flex items-center justify-between px-6 text-white">
                         <button 
                            disabled={currentPage === 1}
                            onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                            className="p-2 disabled:opacity-30"
                        >
                            <i className="fa-solid fa-chevron-left"></i>
                         </button>
                         <span className="text-sm">Page {currentPage} / {totalPages}</span>
                         <button 
                            disabled={currentPage === totalPages}
                            onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                            className="p-2 disabled:opacity-30"
                        >
                            <i className="fa-solid fa-chevron-right"></i>
                         </button>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [studentId, setStudentId] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                const trimmedId = studentId.trim();
                
                if (trimmedId && studentDatabase[trimmedId]) {
                    const studentName = studentDatabase[trimmedId];
                    const nameParts = studentName.split(' ').filter(part => part.trim() !== '');
                    const initialsName = nameParts.length >= 2 
                        ? `${nameParts[0]}+${nameParts[1]}` 
                        : nameParts[0];

                    onLogin({
                        name: studentName,
                        studentId: trimmedId,
                        avatarUrl: `https://ui-avatars.com/api/?name=${initialsName}&background=random&color=fff`,
                        department: 'Faculty of Business Management'
                    });
                } else {
                    setError('Invalid Student ID. ID not found in the current semester database.');
                }
            };

            return (
                <div className="flex h-dvh w-full items-center justify-center bg-slate-100 dark:bg-nexus-dark bg-[url('https://images.unsplash.com/photo-1507842217121-9e962835bf0e?q=80&w=2000&auto=format&fit=crop')] bg-cover bg-center overflow-hidden transition-colors duration-500">
                    <div className="absolute inset-0 bg-white/40 dark:bg-nexus-dark/80 backdrop-blur-sm transition-colors duration-500"></div>
                    
                    <div className="relative z-10 w-full max-w-[90%] md:max-w-md p-6 md:p-8 bg-white/70 dark:bg-white/10 backdrop-blur-xl border border-white/40 dark:border-white/20 rounded-3xl shadow-2xl animate-fade-in mx-auto transition-colors">
                        <div className="flex flex-col items-center mb-8">
                            <div className="flex items-center gap-4 mb-4">
                                <div className="w-14 h-14 md:w-16 md:h-16 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-lg shadow-purple-500/30">
                                    <i className="fa-solid fa-layer-group text-white text-2xl md:text-3xl"></i>
                                </div>
                            </div>
                            <h1 className="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white tracking-wide text-center transition-colors">PTAR <span className="text-purple-600 dark:text-purple-400">NEXUS</span></h1>
                            <p className="text-slate-600 dark:text-gray-400 mt-2 text-sm md:text-base text-center transition-colors">Sign in to your digital library</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2 transition-colors">Student ID</label>
                                <div className="relative">
                                    <span className="absolute left-4 top-3.5 text-slate-500 dark:text-gray-400"><i className="fa-solid fa-id-badge"></i></span>
                                    <input 
                                        type="text" 
                                        value={studentId}
                                        onChange={(e) => {
                                            setStudentId(e.target.value);
                                            setError('');
                                        }}
                                        className="w-full pl-11 pr-4 py-3 bg-white dark:bg-black/20 border border-slate-300 dark:border-white/10 rounded-xl text-slate-900 dark:text-white focus:outline-none focus:border-purple-500 focus:bg-white dark:focus:bg-black/40 transition-all text-sm md:text-base shadow-sm"
                                        placeholder="e.g. 2024441674"
                                    />
                                </div>
                            </div>
                            
                            {error && (
                                <div className="p-3 rounded-lg bg-red-100 dark:bg-red-500/20 border border-red-200 dark:border-red-500/30 text-red-600 dark:text-red-200 text-xs md:text-sm text-center">
                                    <i className="fa-solid fa-circle-exclamation mr-2"></i>
                                    {error}
                                </div>
                            )}

                            <button 
                                type="submit" 
                                className="w-full py-3.5 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-xl shadow-lg shadow-purple-900/40 transition-all transform hover:scale-[1.02] text-sm md:text-base"
                            >
                                Sign In
                            </button>
                        </form>
                        
                        <div className="mt-8 text-center">
                             <p className="text-xs text-slate-500 dark:text-gray-500 mb-2 transition-colors">Registered Students Only</p>
                             <div className="text-[10px] text-slate-400 dark:text-gray-600 font-mono transition-colors">
                                Try: 2024441674 (e.g. 2024xxxxxx)
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab, onLogout }) => {
            const menuItems = [
                { id: 'dashboard', icon: 'fa-table-columns', label: 'Dashboard' },
                { id: 'search', icon: 'fa-magnifying-glass', label: 'Search' },
                { id: 'rooms', icon: 'fa-people-roof', label: 'Room Booking' },
                { id: 'digital-id', icon: 'fa-id-card', label: 'My Digital ID' },
                { id: 'analytics', icon: 'fa-chart-line', label: 'Analytics' },
                { id: 'feedback', icon: 'fa-comment-dots', label: 'Feedback' },
            ];

            return (
                <aside className="w-16 md:w-20 lg:w-64 h-full flex flex-col transition-all duration-300 bg-white/80 dark:bg-nexus-dark/80 backdrop-blur-xl border-r border-slate-200 dark:border-nexus-glassBorder z-20 flex-shrink-0">
                    <div className="h-20 md:h-24 flex flex-col lg:flex-row items-center justify-center lg:justify-start lg:px-6 border-b border-slate-200 dark:border-nexus-glassBorder gap-2">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 md:w-10 md:h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-lg shadow-purple-500/30 flex-shrink-0">
                                <i className="fa-solid fa-layer-group text-white text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <span className="hidden lg:block font-bold text-lg text-slate-800 dark:text-white tracking-wide leading-tight">
                            PTAR <span className="text-purple-600 dark:text-purple-400">NEXUS</span>
                        </span>
                    </div>

                    <nav className="flex-1 py-4 md:py-6 flex flex-col gap-2 px-2 md:px-3 overflow-y-auto scrollbar-hide">
                        {menuItems.map((item) => (
                            <button
                                key={item.id}
                                onClick={() => setActiveTab(item.id)}
                                className={`flex items-center justify-center lg:justify-start p-2 md:p-3 rounded-xl transition-all duration-200 group ${
                                    activeTab === item.id
                                        ? 'bg-purple-600 text-white shadow-lg shadow-purple-600/20'
                                        : 'text-slate-500 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-white/5 hover:text-slate-900 dark:hover:text-white'
                                }`}
                            >
                                <i className={`fa-solid ${item.icon} w-6 text-center text-lg ${activeTab === item.id ? 'text-white' : 'text-slate-500 dark:text-gray-400 group-hover:text-purple-600 dark:group-hover:text-purple-400'}`}></i>
                                <span className="hidden lg:block ml-3 font-medium whitespace-nowrap">{item.label}</span>
                            </button>
                        ))}
                    </nav>

                    <div className="p-2 md:p-4 border-t border-slate-200 dark:border-nexus-glassBorder">
                        <button 
                            onClick={onLogout}
                            className="flex items-center justify-center lg:justify-start w-full p-2 md:p-3 rounded-xl text-slate-500 dark:text-gray-400 hover:bg-red-500/10 hover:text-red-500 dark:hover:text-red-400 transition-colors"
                        >
                            <i className="fa-solid fa-arrow-right-from-bracket w-6 text-center"></i>
                            <span className="hidden lg:block ml-3 font-medium">Logout</span>
                        </button>
                    </div>
                </aside>
            );
        };

        const Header = ({ user, isOnline, setIsOnline, notifications, theme, toggleTheme, onOpenProfile }) => {
            const [showNotifDropdown, setShowNotifDropdown] = useState(false);
            const fullName = user.name; 
            const unreadCount = notifications.length;

            return (
                <header className="h-16 md:h-20 px-4 md:px-6 flex items-center justify-between bg-white/60 dark:bg-nexus-dark/60 backdrop-blur-md sticky top-0 z-10 border-b border-slate-200 dark:border-nexus-glassBorder flex-shrink-0 transition-colors">
                    <div className="overflow-hidden mr-4">
                        <h1 className="text-base md:text-xl font-bold text-slate-800 dark:text-white truncate">
                            Hi, <span className="text-purple-600 dark:text-purple-400">{fullName}</span>
                        </h1>
                        <p className="text-[10px] md:text-sm text-slate-500 dark:text-gray-400 truncate hidden sm:block">{user.department}</p>
                    </div>

                    <div className="flex items-center gap-3 md:gap-6">
                        {/* Theme Toggle */}
                        <button 
                            onClick={toggleTheme}
                            className="w-8 h-8 md:w-10 md:h-10 rounded-full bg-slate-200 dark:bg-white/5 hover:bg-slate-300 dark:hover:bg-white/10 flex items-center justify-center text-slate-600 dark:text-yellow-300 transition-colors"
                        >
                            <i className={`fa-solid ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`}></i>
                        </button>

                        <div 
                            onClick={() => setIsOnline(!isOnline)}
                            className={`cursor-pointer px-2 py-1 md:px-4 md:py-2 rounded-full border flex items-center gap-2 transition-all duration-300 ${
                                isOnline 
                                    ? 'bg-green-500/10 border-green-500/30 text-green-600 dark:text-green-400' 
                                    : 'bg-red-500/10 border-red-500/30 text-red-600 dark:text-red-400'
                            }`}
                        >
                            <div className={`w-1.5 h-1.5 md:w-2 md:h-2 rounded-full ${isOnline ? 'bg-green-500 dark:bg-green-400 animate-pulse' : 'bg-red-500 dark:bg-red-400'}`}></div>
                            <span className="text-[10px] md:text-sm font-semibold hidden md:inline">{isOnline ? 'Online' : 'Offline'}</span>
                        </div>

                        <div className="flex items-center gap-3 pl-3 md:pl-6 border-l border-slate-200 dark:border-nexus-glassBorder relative">
                            {/* Notification Bell */}
                            <button 
                                onClick={() => setShowNotifDropdown(!showNotifDropdown)}
                                className="w-8 h-8 md:w-10 md:h-10 rounded-full bg-slate-200 dark:bg-white/5 hover:bg-slate-300 dark:hover:bg-white/10 flex items-center justify-center text-slate-600 dark:text-white transition-colors relative"
                            >
                                <i className="fa-solid fa-bell text-sm md:text-base"></i>
                                {unreadCount > 0 && (
                                    <span className="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full text-white text-[10px] flex items-center justify-center font-bold border-2 border-white dark:border-nexus-dark">{unreadCount}</span>
                                )}
                            </button>
                            
                            {/* Dropdown */}
                            {showNotifDropdown && (
                                <div className="absolute top-12 right-2 md:right-12 w-72 bg-white dark:bg-slate-800 border border-slate-200 dark:border-white/10 rounded-xl shadow-2xl overflow-hidden z-50 animate-fade-in">
                                    <div className="px-4 py-3 border-b border-slate-200 dark:border-white/10 bg-slate-50 dark:bg-slate-900/50">
                                        <h4 className="text-sm font-semibold text-slate-800 dark:text-white">Notifications</h4>
                                    </div>
                                    <div className="max-h-64 overflow-y-auto">
                                        {notifications.length === 0 ? (
                                            <div className="p-4 text-center text-slate-500 dark:text-gray-500 text-xs">No new notifications</div>
                                        ) : (
                                            notifications.map((notif, idx) => (
                                                <div key={idx} className="p-3 border-b border-slate-100 dark:border-white/5 hover:bg-slate-50 dark:hover:bg-white/10 transition-colors">
                                                    <p className="text-xs text-slate-700 dark:text-gray-300">{notif.message}</p>
                                                    <span className="text-[10px] text-slate-400 dark:text-gray-500 mt-1 block">{notif.time}</span>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            <img 
                                src={user.avatarUrl} 
                                alt={user.name} 
                                onClick={onOpenProfile}
                                className="w-8 h-8 md:w-10 md:h-10 rounded-full border-2 border-purple-500/50 object-cover cursor-pointer hover:border-purple-400 transition-colors"
                            />
                        </div>
                    </div>
                </header>
            );
        };

        const BookDetailModal = ({ book, onClose, onToggleBorrow, isBorrowed, onRead, onRenew }) => {
            if (!book) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-2xl w-full max-w-2xl max-h-[90dvh] shadow-2xl flex flex-col md:flex-row overflow-hidden animate-fade-in transition-colors">
                        {/* Close Button */}
                        <button onClick={onClose} className="absolute top-3 right-3 z-10 w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-white/20 transition-colors">
                            <i className="fa-solid fa-xmark"></i>
                        </button>

                        {/* Image Section */}
                        <div className="w-full md:w-1/3 h-48 md:h-auto relative flex-shrink-0 bg-slate-100 dark:bg-white/5">
                             {book.coverImage !== 'placeholder' ? (
                                <img src={book.coverImage} alt={book.title} className="w-full h-full object-cover" />
                            ) : (
                                <div className="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500">
                                    <i className="fa-solid fa-book text-4xl"></i>
                                </div>
                            )}
                            <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent md:hidden"></div>
                        </div>

                        {/* Content Section */}
                        <div className="p-6 md:p-8 flex-1 flex flex-col min-h-0">
                            <div className="mb-4">
                                <div className="flex items-center gap-2 mb-2 flex-wrap">
                                     <span className="px-2 py-1 rounded text-xs font-bold bg-purple-100 dark:bg-purple-500/20 text-purple-600 dark:text-purple-300 border border-purple-200 dark:border-purple-500/30">{book.type}</span>
                                     <span className="px-2 py-1 rounded text-xs font-bold bg-slate-100 dark:bg-white/10 text-slate-600 dark:text-gray-300 border border-slate-200 dark:border-white/10">{book.genre || 'General'}</span>
                                </div>
                                <h2 className="text-xl md:text-2xl font-bold text-slate-900 dark:text-white leading-tight mb-1">{book.title}</h2>
                                <p className="text-base text-slate-500 dark:text-gray-400">by <span className="text-slate-700 dark:text-gray-200">{book.author}</span> <span className="text-gray-400 dark:text-gray-600 mx-1"></span> Published: <span className="text-slate-700 dark:text-gray-200">{book.year}</span></p>
                            </div>

                            <div className="flex-1 overflow-y-auto mb-6 pr-2 scrollbar-hide">
                                <h3 className="text-xs font-semibold text-slate-400 dark:text-gray-500 mb-2 uppercase tracking-wider">Summary</h3>
                                <p className="text-slate-600 dark:text-gray-300 text-sm leading-relaxed">{book.summary || 'No summary available for this title.'}</p>
                                
                                {isBorrowed && book.type === ResourceType.PHYSICAL && (
                                    <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-500/10 border border-blue-200 dark:border-blue-500/20 rounded-lg">
                                        <h4 className="text-xs font-bold text-blue-700 dark:text-blue-300 mb-1">
                                            <i className="fa-solid fa-circle-info mr-1"></i> Renewal Policy
                                        </h4>
                                        <p className="text-[10px] text-blue-600 dark:text-blue-200">
                                            Online renewal is allowed once for an additional 7 days, provided the item is not reserved by another user and you have no outstanding fines.
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div className="flex gap-3 mt-auto pt-4 border-t border-slate-200 dark:border-white/5">
                                 {/* Action Buttons based on type */}
                                 {book.type === ResourceType.PHYSICAL ? (
                                    <>
                                     {isBorrowed && (
                                         <button
                                            onClick={() => onRenew(book)}
                                            className="flex-1 py-3 px-4 rounded-xl font-bold bg-blue-500/10 dark:bg-blue-500/20 hover:bg-blue-500 hover:text-white dark:hover:text-white text-blue-600 dark:text-blue-300 border border-blue-500/50 transition-all text-sm flex items-center justify-center gap-2"
                                         >
                                            <i className="fa-solid fa-clock-rotate-left"></i>
                                            Renew Loan
                                         </button>
                                     )}
                                     <button
                                        onClick={() => onToggleBorrow(book)}
                                        className={`flex-1 py-3 px-4 rounded-xl font-bold transition-all text-sm flex items-center justify-center gap-2 ${isBorrowed ? 'bg-red-500/10 dark:bg-red-500/20 hover:bg-red-500 hover:text-white text-red-600 dark:text-red-300 border border-red-500/50' : 'bg-green-500/10 dark:bg-green-500/20 hover:bg-green-500 hover:text-white dark:hover:text-black text-green-600 dark:text-green-300 border border-green-500/50'}`}
                                     >
                                        <i className={`fa-solid ${isBorrowed ? 'fa-rotate-left' : 'fa-book-open'}`}></i>
                                        {isBorrowed ? 'Return Book' : 'Borrow Book'}
                                     </button>
                                    </>
                                 ) : (
                                     <button 
                                        onClick={() => onRead(book)}
                                        className="flex-1 py-3 px-4 rounded-xl font-bold bg-cyan-500/10 dark:bg-cyan-500/20 hover:bg-cyan-500 hover:text-white dark:hover:text-black text-cyan-600 dark:text-cyan-300 border border-cyan-500/50 transition-all text-sm flex items-center justify-center gap-2"
                                     >
                                        <i className="fa-solid fa-book-reader"></i>
                                        Read Now
                                     </button>
                                 )}
                            </div>
                        </div>
                    </div>
                </div>
            )
        };

        const FeedbackView = () => {
             const [formData, setFormData] = useState({ type: 'Bug', description: '', urgency: 'Normal' });
             const [isSubmitting, setIsSubmitting] = useState(false);
             const [isSubmitted, setIsSubmitted] = useState(false);

             const handleSubmit = (e) => {
                 e.preventDefault();
                 setIsSubmitting(true);
                 // Simulate API call
                 setTimeout(() => {
                     setIsSubmitting(false);
                     setIsSubmitted(true);
                     setTimeout(() => {
                         setIsSubmitted(false);
                         setFormData({ type: 'Bug', description: '', urgency: 'Normal' });
                     }, 3000);
                 }, 1500);
             };

             return (
                <div className="bg-white/60 dark:bg-white/5 backdrop-blur-md border border-slate-200 dark:border-white/10 rounded-2xl p-6 md:p-8 shadow-xl max-w-2xl mx-auto mt-10 transition-colors animate-fade-in">
                    <div className="flex items-center gap-4 mb-6">
                        <div className="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-600/20 flex items-center justify-center text-purple-600 dark:text-purple-300">
                             <i className="fa-solid fa-comment-dots text-xl"></i>
                        </div>
                        <div>
                            <h2 className="text-xl md:text-2xl font-bold text-slate-800 dark:text-white">Feedback & Reporting</h2>
                            <p className="text-slate-500 dark:text-gray-400 text-sm">Help us improve PTAR Nexus by reporting issues.</p>
                        </div>
                    </div>

                    {isSubmitted ? (
                        <div className="p-8 bg-green-500/10 border border-green-500/20 rounded-xl text-center animate-fade-in">
                            <i className="fa-solid fa-circle-check text-4xl text-green-500 mb-3"></i>
                            <h3 className="text-lg font-bold text-green-700 dark:text-green-300">Feedback Received!</h3>
                            <p className="text-sm text-green-600 dark:text-green-200 mt-2">
                                Thank you for your report. Our technical team has been notified and system logs have been attached.
                            </p>
                        </div>
                    ) : (
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Issue Type</label>
                                    <select 
                                        value={formData.type}
                                        onChange={(e) => setFormData({...formData, type: e.target.value})}
                                        className="w-full bg-slate-100 dark:bg-black/30 border border-slate-300 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-purple-500 transition-colors appearance-none"
                                    >
                                        <option>Bug Report</option>
                                        <option>Feature Request</option>
                                        <option>UX Improvement</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Urgency</label>
                                    <select 
                                        value={formData.urgency}
                                        onChange={(e) => setFormData({...formData, urgency: e.target.value})}
                                        className="w-full bg-slate-100 dark:bg-black/30 border border-slate-300 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-purple-500 transition-colors appearance-none"
                                    >
                                        <option>Low</option>
                                        <option>Normal</option>
                                        <option>High</option>
                                        <option>Critical</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2">Description</label>
                                <textarea 
                                    rows="5"
                                    required
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    placeholder="Please describe the issue or your suggestion in detail..."
                                    className="w-full bg-slate-100 dark:bg-black/30 border border-slate-300 dark:border-white/10 rounded-xl px-4 py-3 text-slate-900 dark:text-white focus:outline-none focus:border-purple-500 transition-colors resize-none"
                                ></textarea>
                            </div>

                            <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-gray-400 bg-slate-100 dark:bg-white/5 p-3 rounded-lg border border-slate-200 dark:border-white/5">
                                <i className="fa-solid fa-code text-purple-500"></i>
                                <span>System logs and user session data will be automatically linked to this report for diagnostics.</span>
                            </div>

                            <button 
                                type="submit" 
                                disabled={isSubmitting}
                                className="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold shadow-lg shadow-purple-900/20 hover:scale-[1.01] active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            >
                                {isSubmitting ? <><i className="fa-solid fa-spinner fa-spin"></i> Sending...</> : 'Submit Feedback'}
                            </button>
                        </form>
                    )}
                </div>
             );
        };
        
        // Define ResultCard outside UnifiedSearch
        const ResultCard = ({ result, isBorrowed, isLiked, onBookClick, onToggleBorrow, onToggleLike, onRead }) => {
            const isPhysical = result.type === ResourceType.PHYSICAL;
            const isPtarDigital = result.availability === 'PTAR Digital';

            return (
                <div 
                    className="flex flex-row bg-white/60 dark:bg-white/5 backdrop-blur-sm border border-slate-200 dark:border-white/10 rounded-xl overflow-hidden hover:bg-white dark:hover:bg-white/10 hover:shadow-xl dark:hover:border-purple-500/30 transition-all duration-300 group h-full cursor-pointer relative shadow-sm"
                    onClick={() => onBookClick(result)}
                >
                    <div className="w-24 md:w-32 flex-shrink-0 relative bg-slate-100 dark:bg-black/20">
                        {result.coverImage !== 'placeholder' ? (
                            <img 
                                src={result.coverImage} 
                                alt={result.title} 
                                className="w-full h-full object-cover"
                                loading="lazy"
                            />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-gray-500 bg-white/5">
                                <div className="text-center p-2">
                                    <i className={`fa-solid ${isPhysical ? 'fa-book' : 'fa-laptop-code'} text-2xl mb-1`}></i>
                                    <div className="text-[9px] uppercase font-bold text-gray-600">{result.type}</div>
                                </div>
                            </div>
                        )}
                        
                        <div className="absolute top-2 left-2 flex flex-col gap-1">
                            {isPhysical ? (
                                <span className="px-1.5 py-0.5 md:px-2 md:py-1 bg-amber-500/90 text-black text-[9px] md:text-[10px] font-bold rounded shadow-md">Physical</span>
                            ) : isPtarDigital ? (
                                <span className="px-1.5 py-0.5 md:px-2 md:py-1 bg-purple-500/90 text-white text-[9px] md:text-[10px] font-bold rounded shadow-md">PTAR Online</span>
                            ) : (
                                <span className="px-1.5 py-0.5 md:px-2 md:py-1 bg-cyan-500/90 text-black text-[9px] md:text-[10px] font-bold rounded shadow-md">Open Web</span>
                            )}
                        </div>
                    </div>
                    
                    <div className="p-3 md:p-4 flex flex-col justify-between flex-1 min-w-0">
                        <div>
                            <div className="text-[9px] md:text-[10px] text-purple-600 dark:text-purple-300 uppercase font-bold tracking-wider mb-1 truncate">{result.genre}</div>
                            <h4 className="text-slate-900 dark:text-white font-bold text-sm md:text-base leading-tight mb-1 line-clamp-2 group-hover:text-purple-600 dark:group-hover:text-purple-300 transition-colors">{result.title}</h4>
                            <p className="text-slate-500 dark:text-gray-400 text-xs mb-2 truncate">{result.author}  {result.year}</p>
                            
                            {isPhysical ? (
                                <div className="flex items-start gap-2 text-xs text-slate-600 dark:text-gray-300 bg-slate-100 dark:bg-white/5 p-2 rounded-lg">
                                    <i className="fa-solid fa-location-dot mt-0.5 text-amber-500 dark:text-amber-400 flex-shrink-0"></i>
                                    <div className="overflow-hidden min-w-0">
                                        <p className="font-medium text-amber-700 dark:text-amber-200 truncate">{result.shelfLocation}</p>
                                        <p className="text-[10px] opacity-70 truncate">Call No: {result.callNumber}</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex items-center gap-2 text-xs text-slate-600 dark:text-gray-300 bg-slate-100 dark:bg-white/5 p-2 rounded-lg">
                                    {isPtarDigital ? <i className="fa-solid fa-lock text-purple-600 dark:text-purple-400 flex-shrink-0"></i> : <i className="fa-solid fa-globe text-cyan-600 dark:text-cyan-400 flex-shrink-0"></i>}
                                    <p className={`font-medium truncate ${isPtarDigital ? 'text-purple-700 dark:text-purple-200' : 'text-cyan-700 dark:text-cyan-200'}`}>
                                        {isPtarDigital ? 'Authorized Student Access' : 'Public Digital Access'}
                                    </p>
                                </div>
                            )}
                        </div>

                        <div className="mt-3 flex gap-2">
                            {isPhysical ? (
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation(); 
                                        onToggleBorrow(result);
                                    }}
                                    className={`flex-1 py-1.5 px-2 md:px-3 border rounded-lg text-[10px] md:text-xs font-medium transition-all whitespace-nowrap ${
                                        isBorrowed 
                                            ? 'bg-red-500/10 dark:bg-red-500/20 hover:bg-red-500 hover:text-white border-red-500/50 text-red-600 dark:text-red-300' 
                                            : 'bg-slate-100 dark:bg-white/10 hover:bg-green-500 hover:text-white dark:hover:text-black border-slate-200 dark:border-white/20 text-slate-700 dark:text-white'
                                    }`}
                                >
                                    {isBorrowed ? 'Return' : 'Borrow'}
                                </button>
                            ) : (
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        onRead(result);
                                    }}
                                    className={`flex-1 py-1.5 px-2 md:px-3 border rounded-lg text-[10px] md:text-xs font-medium transition-all flex items-center justify-center gap-2 whitespace-nowrap ${
                                            isPtarDigital 
                                            ? 'bg-purple-600/10 dark:bg-purple-600/20 hover:bg-purple-500 hover:text-white border-purple-500/50 text-purple-700 dark:text-purple-300' 
                                            : 'bg-cyan-600/10 dark:bg-cyan-600/20 hover:bg-cyan-500 hover:text-white dark:hover:text-black border-cyan-500/50 text-cyan-700 dark:text-cyan-300'
                                    }`}
                                >
                                        <i className="fa-solid fa-book-reader"></i> {isPtarDigital ? 'View' : 'Read'}
                                </button>
                            )}
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    onToggleLike(result);
                                }}
                                className={`w-8 flex items-center justify-center rounded-lg transition-colors ${isLiked ? 'bg-pink-500/10 dark:bg-pink-500/20 text-pink-600 dark:text-pink-400 border border-pink-500/30' : 'bg-slate-100 dark:bg-white/5 hover:bg-slate-200 dark:hover:bg-white/20 text-slate-400 dark:text-white'}`}
                            >
                                <i className={`${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart`}></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const UnifiedSearch = ({ borrowedBooks, onToggleBorrow, likedBooks, onToggleLike, onRenew }) => {
            const [query, setQuery] = useState('');
            const [activeGenre, setActiveGenre] = useState(Genre.ALL); 
            const [activeSource, setActiveSource] = useState('ALL'); // New State for Source Filter
            const [selectedBook, setSelectedBook] = useState(null);
            const [readingBook, setReadingBook] = useState(null); // Book currently being read
            
            // API State
            const [onlineBooks, setOnlineBooks] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [apiError, setApiError] = useState('');

            // Debounce ref
            const debounceTimeout = useRef(null);

            // Handler for Reading
            const handleReadBook = (book) => {
                if (book.url) {
                    window.open(book.url, '_blank');
                    return;
                }
                
                if (book.availability === 'PTAR Digital') {
                    // Open Internal Reader for Local Digital Items
                    setReadingBook(book);
                    setSelectedBook(null); // Close modal if open
                } else if (book.key) {
                    // For Open Library, append /read to key to open the viewer directly
                    const readUrl = `https://openlibrary.org${book.key}/read`;
                    window.open(readUrl, '_blank');
                } else {
                    alert("Reader not available for this resource.");
                }
            };

            // Fetch Open Library Data based on Search Query or Genre Subject
            const fetchOpenLibrary = async (searchQuery, genre) => {
                setIsLoading(true);
                setApiError('');
                try {
                    let url = '';
                    
                    if (searchQuery) {
                        // User is searching for something specific
                        url = `https://openlibrary.org/search.json?q=${encodeURIComponent(searchQuery)}&limit=16`;
                    } else {
                        // User is browsing a genre category
                        let subject = 'university'; // Default "All" fallback
                        
                        switch(genre) {
                            case Genre.TECH: subject = 'computer_science'; break;
                            case Genre.BUSINESS: subject = 'business_management'; break;
                            case Genre.FICTION: subject = 'fiction'; break;
                            case Genre.SCIENCE: subject = 'science'; break;
                            case Genre.HISTORY: subject = 'history'; break;
                            default: subject = 'textbooks'; break;
                        }
                        url = `https://openlibrary.org/subjects/${subject}.json?limit=16`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();

                    // Handle Subject API vs Search API result structure
                    let books = [];
                    if (data.works) { // Subject API returns 'works'
                        books = data.works;
                    } else if (data.docs) { // Search API returns 'docs'
                        books = data.docs;
                    }

                    if (books.length > 0) {
                        const formattedBooks = books.map(doc => ({
                            id: doc.key, 
                            key: doc.key, 
                            title: doc.title,
                            author: doc.authors ? doc.authors[0].name : (doc.author_name ? doc.author_name[0] : 'Unknown Author'),
                            year: doc.first_publish_year || 'N/A',
                            type: ResourceType.EBOOK, 
                            genre: genre === Genre.ALL ? Genre.ALL : genre, // Assign current genre if browsing
                            availability: 'Digital Access',
                            coverImage: doc.cover_id 
                                ? `https://covers.openlibrary.org/b/id/${doc.cover_id}-M.jpg` 
                                : (doc.cover_i ? `https://covers.openlibrary.org/b/id/${doc.cover_i}-M.jpg` : 'placeholder'),
                            summary: 'View full details on Open Library.'
                        }));
                        setOnlineBooks(formattedBooks);
                    } else {
                        setOnlineBooks([]);
                    }
                } catch (err) {
                    console.error("OpenLibrary API Error:", err);
                    setApiError("Failed to fetch digital resources. Please check connection.");
                } finally {
                    setIsLoading(false);
                }
            };

            // Fetch when Active Genre changes (and no search query is active)
            useEffect(() => {
                if (!query) {
                    fetchOpenLibrary('', activeGenre);
                }
            }, [activeGenre]);

            // Fetch when Query changes (Debounced)
            useEffect(() => {
                if (debounceTimeout.current) clearTimeout(debounceTimeout.current);
                
                if (query) {
                     debounceTimeout.current = setTimeout(() => {
                        fetchOpenLibrary(query, activeGenre);
                    }, 800);
                } else {
                    // Reset to genre browse if query cleared
                    fetchOpenLibrary('', activeGenre);
                }

                return () => clearTimeout(debounceTimeout.current);
            }, [query]);

            
            // Filter logic (Separated for Grouping)
            const physicalResults = localPhysicalInventory.filter(item => {
                const matchesGenre = activeGenre === Genre.ALL || item.genre === activeGenre;
                const matchesQuery = !query || 
                                     item.title.toLowerCase().includes(query.toLowerCase()) || 
                                     item.author.toLowerCase().includes(query.toLowerCase());
                return matchesGenre && matchesQuery;
            });

            const ptarDigitalResults = localDigitalInventory.filter(item => {
                const matchesGenre = activeGenre === Genre.ALL || item.genre === activeGenre;
                const matchesQuery = !query || 
                                     item.title.toLowerCase().includes(query.toLowerCase()) || 
                                     item.author.toLowerCase().includes(query.toLowerCase());
                return matchesGenre && matchesQuery;
            });

            const openLibraryResults = onlineBooks; // onlineBooks is already updated based on query/genre

            // Calculate total visible results based on active source filter
            let totalVisible = 0;
            if (activeSource === 'ALL' || activeSource === 'PHYSICAL') totalVisible += physicalResults.length;
            if (activeSource === 'ALL' || activeSource === 'PTAR_DIGITAL') totalVisible += ptarDigitalResults.length;
            if (activeSource === 'ALL' || activeSource === 'OPEN_LIBRARY') totalVisible += openLibraryResults.length;

            const filters = Object.values(Genre);

            // Source Navigation Data
            const sourceNav = [
                { id: 'ALL', label: 'All Sources', icon: 'fa-layer-group', color: 'bg-gray-600' },
                { id: 'PHYSICAL', label: 'Physical Books', icon: 'fa-book', color: 'bg-amber-600' },
                { id: 'PTAR_DIGITAL', label: 'UiTM Digital', icon: 'fa-server', color: 'bg-purple-600' },
                { id: 'OPEN_LIBRARY', label: 'Global Online', icon: 'fa-globe', color: 'bg-cyan-600' },
            ];

            return (
                <div className="w-full max-w-6xl mx-auto relative">
                    {/* Search & Filter Section */}
                    <div className="mb-6 md:mb-8">
                        {/* Search Input */}
                        <div className="relative mb-4 md:mb-6">
                            <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i className={`fa-solid ${isLoading ? 'fa-spinner fa-spin' : 'fa-magnifying-glass'} text-slate-400 dark:text-gray-400 text-lg`}></i>
                            </div>
                            <input
                                type="text"
                                className="block w-full pl-12 pr-4 py-3 md:py-4 bg-white/70 dark:bg-white/5 backdrop-blur-md border border-slate-200 dark:border-white/10 rounded-2xl text-sm md:text-base text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:bg-white dark:focus:bg-white/10 transition-all shadow-xl"
                                placeholder="Search by Title, Author, or Call Number..."
                                value={query}
                                onChange={(e) => setQuery(e.target.value)}
                            />
                        </div>

                        {/* NEW: Source Navigation Buttons */}
                        <div className="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2 md:mx-0 md:px-0">
                            {sourceNav.map(source => (
                                <button
                                    key={source.id}
                                    onClick={() => setActiveSource(source.id)}
                                    className={`flex items-center px-4 py-2.5 rounded-xl text-xs md:text-sm font-bold whitespace-nowrap transition-all flex-shrink-0 border ${
                                        activeSource === source.id 
                                        ? `${source.color} text-white border-white/20 shadow-lg transform scale-105` 
                                        : 'bg-white dark:bg-white/5 text-slate-500 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-white border-slate-200 dark:border-white/5'
                                    }`}
                                >
                                    <i className={`fa-solid ${source.icon} mr-2`}></i>
                                    {source.label}
                                </button>
                            ))}
                        </div>

                        {/* Genre Tabs */}
                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-2 px-2 md:mx-0 md:px-0">
                            {filters.map(genre => (
                                <button
                                    key={genre}
                                    onClick={() => setActiveGenre(genre)}
                                    className={`px-3 py-1.5 md:px-4 md:py-2 rounded-xl text-xs md:text-sm font-medium whitespace-nowrap transition-all flex-shrink-0 ${
                                        activeGenre === genre 
                                        ? 'bg-purple-600 text-white shadow-lg shadow-purple-600/20' 
                                        : 'bg-white dark:bg-white/5 text-slate-500 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-white/10 hover:text-slate-900 dark:hover:text-white border border-slate-200 dark:border-white/5'
                                    }`}
                                >
                                    {genre}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Results Display */}
                    <div>
                        <h3 className="text-slate-700 dark:text-white/80 font-semibold text-base mb-6 flex items-center justify-between">
                            <span className="flex items-center">
                                <i className="fa-solid fa-layer-group mr-2"></i> 
                                {query ? `Results for "${query}"` : `${activeGenre}`}
                            </span>
                            <span className="text-xs text-slate-500 dark:text-gray-500 font-normal">
                                {isLoading ? 'Fetching online library...' : `${totalVisible} resources found`}
                            </span>
                        </h3>

                        {apiError && (
                            <div className="p-4 mb-4 bg-red-100 dark:bg-red-500/10 border border-red-200 dark:border-red-500/20 rounded-xl text-red-700 dark:text-red-300 text-sm">
                                {apiError}
                            </div>
                        )}

                        {/* Section: UiTM Physical Collection */}
                        {physicalResults.length > 0 && (activeSource === 'ALL' || activeSource === 'PHYSICAL') && (
                            <div className="mb-8 animate-fade-in">
                                <div className="flex items-center gap-2 mb-3 px-1">
                                    <div className="w-1 h-4 bg-amber-500 rounded-full"></div>
                                    <h4 className="text-amber-500 font-bold text-sm tracking-wide uppercase">UiTM Physical Collection</h4>
                                    <div className="h-px bg-slate-200 dark:bg-white/5 flex-1 ml-2"></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-3 md:gap-6">
                                    {physicalResults.map((result, idx) => (
                                        <ResultCard 
                                            key={result.id || `phy_${idx}`} 
                                            result={result} 
                                            onBookClick={setSelectedBook} 
                                            isBorrowed={borrowedBooks.has(result.id)}
                                            isLiked={likedBooks.has(result.id)}
                                            onToggleBorrow={onToggleBorrow}
                                            onToggleLike={onToggleLike}
                                            onRead={handleReadBook}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Section: UiTM Digital Archive */}
                        {ptarDigitalResults.length > 0 && (activeSource === 'ALL' || activeSource === 'PTAR_DIGITAL') && (
                            <div className="mb-8 animate-fade-in">
                                <div className="flex items-center gap-2 mb-3 px-1">
                                    <div className="w-1 h-4 bg-purple-500 rounded-full"></div>
                                    <h4 className="text-purple-600 dark:text-purple-400 font-bold text-sm tracking-wide uppercase">UiTM Digital Archive</h4>
                                    <div className="h-px bg-slate-200 dark:bg-white/5 flex-1 ml-2"></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-3 md:gap-6">
                                    {ptarDigitalResults.map((result, idx) => (
                                        <ResultCard 
                                            key={result.id || `dig_${idx}`} 
                                            result={result} 
                                            onBookClick={setSelectedBook} 
                                            isBorrowed={borrowedBooks.has(result.id)}
                                            isLiked={likedBooks.has(result.id)}
                                            onToggleBorrow={onToggleBorrow}
                                            onToggleLike={onToggleLike}
                                            onRead={handleReadBook}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Section: Open Library Global */}
                        {((openLibraryResults.length > 0 || isLoading) && (activeSource === 'ALL' || activeSource === 'OPEN_LIBRARY')) && (
                            <div className="mb-8 animate-fade-in">
                                <div className="flex items-center gap-2 mb-3 px-1">
                                    <div className="w-1 h-4 bg-cyan-500 rounded-full"></div>
                                    <h4 className="text-cyan-600 dark:text-cyan-400 font-bold text-sm tracking-wide uppercase">Global Online Resources (Open Library)</h4>
                                    <div className="h-px bg-slate-200 dark:bg-white/5 flex-1 ml-2"></div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-3 md:gap-6">
                                    {openLibraryResults.map((result, idx) => (
                                        <ResultCard 
                                            key={result.id || `ol_${idx}`} 
                                            result={result} 
                                            onBookClick={setSelectedBook} 
                                            isBorrowed={borrowedBooks.has(result.id)}
                                            isLiked={likedBooks.has(result.id)}
                                            onToggleBorrow={onToggleBorrow}
                                            onToggleLike={onToggleLike}
                                            onRead={handleReadBook}
                                        />
                                    ))}
                                </div>
                                
                                {isLoading && (
                                     <div className="text-center py-10 text-slate-500 dark:text-gray-500 w-full col-span-full">
                                        <i className="fa-solid fa-spinner fa-spin text-2xl mb-2 opacity-50"></i>
                                        <p className="text-xs">Fetching more from global database...</p>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {!isLoading && totalVisible === 0 && (
                            <div className="text-center py-20 text-slate-500 dark:text-gray-500">
                                <i className="fa-solid fa-book-open text-4xl mb-4 opacity-50"></i>
                                <p>No resources found matching your criteria.</p>
                            </div>
                        )}
                    </div>

                    {/* Modal */}
                    <BookDetailModal 
                        book={selectedBook} 
                        onClose={() => setSelectedBook(null)} 
                        onToggleBorrow={onToggleBorrow}
                        isBorrowed={selectedBook ? borrowedBooks.has(selectedBook.id) : false}
                        onRead={handleReadBook}
                        onRenew={onRenew}
                    />

                    {/* Reader Overlay for PTAR Books */}
                    {readingBook && (
                        <BookReader book={readingBook} onClose={() => setReadingBook(null)} />
                    )}
                </div>
            );
        };
            
        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isOnline, setIsOnline] = useState(true);
            const [notifications, setNotifications] = useState([]);
            const [borrowedBooks, setBorrowedBooks] = useState(new Set());
            const [likedBooks, setLikedBooks] = useState(new Set());

            // User Profile State
            const [profileOpen, setProfileOpen] = useState(false);

            // Loan Registration State
            const [loanModalOpen, setLoanModalOpen] = useState(false);
            const [loanBook, setLoanBook] = useState(null);
            const [loanMode, setLoanMode] = useState('BORROW'); // BORROW or RENEW

            // Theme State
            const [theme, setTheme] = useState('dark');

            // Theme Effect
            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            };

            // Booking State
            const [bookingModalOpen, setBookingModalOpen] = useState(false);
            const [selectedRoom, setSelectedRoom] = useState(null);
            
            // Live Room Data State
            const [rooms, setRooms] = useState([]);

            // Real-time Room Update Logic
            useEffect(() => {
                const updateRooms = () => {
                    const now = new Date();
                    const hour = now.getHours(); // 0-23
                    const isWeekend = now.getDay() === 0 || now.getDay() === 6; // 0=Sun, 6=Sat
                    
                    // PTAR Hours: 8 AM - 10 PM Weekdays, 8 AM - 5 PM Weekends
                    const openHour = 8;
                    const closeHour = isWeekend ? 17 : 22;

                    // Base Room Data
                    const baseRooms = [
                        { id: '1', name: 'Discussion Room 1', capacity: 4 },
                        { id: '2', name: 'Discussion Room 2', capacity: 6 },
                        { id: '3', name: 'Discussion Room 3', capacity: 4 },
                        { id: '4', name: 'Discussion Room 4', capacity: 6 },
                        { id: '5', name: 'Studio Room', capacity: 10 },
                    ];

                    const updatedRooms = baseRooms.map((room, index) => {
                        // Check if closed
                        if (hour < openHour || hour >= closeHour) {
                            return { 
                                ...room, 
                                status: 'Closed', 
                                nextAvailable: '8:00 AM' 
                            };
                        }

                        // Simulate status based on time
                        // Using current hour + index to make it deterministic for that hour but different for each room
                        const isOccupied = (hour + index) % 3 === 0; 
                        
                        if (isOccupied) {
                            let nextHour = hour + 1;
                            let ampm = 'AM';
                            if (nextHour >= 12) {
                                ampm = 'PM';
                                if (nextHour > 12) nextHour -= 12;
                            }
                            return { 
                                ...room, 
                                status: 'Occupied', 
                                nextAvailable: `${nextHour}:00 ${ampm}` 
                            };
                        } else {
                            return { 
                                ...room, 
                                status: 'Available', 
                                nextAvailable: 'Now' 
                            };
                        }
                    });
                    setRooms(updatedRooms);
                };

                updateRooms(); // Initial run
                const interval = setInterval(updateRooms, 60000); // Run every minute to update status
                return () => clearInterval(interval);
            }, []);


            const handleLogin = (userData) => {
                setUser(userData);
                setIsLoggedIn(true);
                addNotification(`Welcome back! Login time: ${getMalaysiaTime()}`);
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setUser(null);
                setActiveTab('dashboard');
                setNotifications([]);
                setBorrowedBooks(new Set());
                setLikedBooks(new Set());
            };

            const addNotification = (message) => {
                const newNotif = {
                    message,
                    time: getMalaysiaTime(),
                    read: false
                };
                setNotifications(prev => [newNotif, ...prev]);
            };

            // Initial Trigger for Borrow/Return
            const toggleBorrow = (book) => {
                const newBorrowed = new Set(borrowedBooks);
                if (newBorrowed.has(book.id)) {
                    // Return process (simple toggle for now, usually needs check-in)
                    newBorrowed.delete(book.id);
                    addNotification(`Returned "${book.title}".`);
                    setBorrowedBooks(newBorrowed);
                } else {
                    // Borrow process -> Open Form
                    setLoanBook(book);
                    setLoanMode('BORROW');
                    setLoanModalOpen(true);
                }
            };

            const handleRenewRequest = (book) => {
                setLoanBook(book);
                setLoanMode('RENEW');
                setLoanModalOpen(true);
            };

            const handleLoanConfirm = (loanData) => {
                const { bookId, mode, courseCode, returnDate } = loanData;
                
                if (mode === 'BORROW') {
                    const newBorrowed = new Set(borrowedBooks);
                    newBorrowed.add(bookId);
                    setBorrowedBooks(newBorrowed);
                    addNotification(`Borrowed "${loanBook.title}" for course ${courseCode}. Due: ${returnDate}`);
                } else {
                    addNotification(`Renewed "${loanBook.title}" successfully. New Due Date: ${returnDate}`);
                }
                setLoanModalOpen(false);
                setLoanBook(null);
            };

            const toggleLike = (book) => {
                const newLiked = new Set(likedBooks);
                if (newLiked.has(book.id)) {
                    newLiked.delete(book.id);
                } else {
                    newLiked.add(book.id);
                    addNotification(`Added "${book.title}" to favorites.`);
                }
                setLikedBooks(newLiked);
            };

            // Booking Handlers
            const handleBookClick = (room) => {
                setSelectedRoom(room);
                setBookingModalOpen(true);
            };

            const handleBookingConfirm = (bookingData) => {
                setBookingModalOpen(false);
                addNotification(`Booking Confirmed: ${bookingData.room.name} for ${bookingData.date} at ${bookingData.time}`);
                setSelectedRoom(null);
            };

            if (!isLoggedIn) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return (
                <div className="flex h-dvh bg-slate-50 dark:bg-nexus-dark text-slate-800 dark:text-white font-sans overflow-hidden bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover bg-center transition-colors duration-500">
                    <div className="absolute inset-0 bg-white/60 dark:bg-nexus-dark/90 z-0 transition-colors duration-500"></div>
                    <div className="absolute inset-0 bg-gradient-to-tr from-purple-100/30 dark:from-purple-900/30 to-blue-100/30 dark:to-blue-900/30 z-0 pointer-events-none"></div>

                    <div className="relative z-10 flex w-full h-full">
                        <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} onLogout={handleLogout} />

                        <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                            
                            <Header 
                                user={user} 
                                isOnline={isOnline} 
                                setIsOnline={setIsOnline} 
                                notifications={notifications}
                                theme={theme}
                                toggleTheme={toggleTheme}
                                onOpenProfile={() => setProfileOpen(true)}
                            />

                            <div className="flex-1 overflow-y-auto p-4 md:p-6 scrollbar-hide">
                                {!isOnline && (
                                    <div className="w-full bg-red-100 dark:bg-red-500/20 border border-red-200 dark:border-red-500/40 text-red-800 dark:text-red-100 p-3 rounded-xl mb-4 flex items-center gap-3 animate-pulse text-sm">
                                        <i className="fa-solid fa-triangle-exclamation"></i>
                                        <p><strong>Offline Mode:</strong> Transactions cached.</p>
                                    </div>
                                )}

                                {activeTab === 'dashboard' && (
                                    <div className="flex flex-col gap-6 max-w-7xl mx-auto pb-10">
                                        <div className="w-full">
                                            <div className="mb-2">
                                                <h2 className="text-xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-500 dark:from-white dark:to-gray-400">Search</h2>
                                                <p className="text-slate-500 dark:text-gray-400 text-xs md:text-base">Access Open Library & Physical Resources.</p>
                                            </div>
                                            <UnifiedSearch 
                                                borrowedBooks={borrowedBooks} 
                                                onToggleBorrow={toggleBorrow} 
                                                likedBooks={likedBooks}
                                                onToggleLike={toggleLike}
                                                onRenew={handleRenewRequest}
                                            />
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6">
                                            <div className="md:col-span-5 lg:col-span-3">
                                                <DigitalID user={user} />
                                            </div>

                                            <div className="md:col-span-7 lg:col-span-5">
                                                <RoomBooking onBookClick={handleBookClick} rooms={rooms} />
                                            </div>

                                            <div className="md:col-span-12 lg:col-span-4">
                                                <Analytics />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'search' && <div className="pb-10">
                                    <UnifiedSearch 
                                        borrowedBooks={borrowedBooks} 
                                        onToggleBorrow={toggleBorrow}
                                        likedBooks={likedBooks}
                                        onToggleLike={toggleLike}
                                        onRenew={handleRenewRequest}
                                    />
                                </div>}
                                {activeTab === 'rooms' && (
                                    <div className="max-w-4xl mx-auto h-full pb-10">
                                        <RoomBooking onBookClick={handleBookClick} rooms={rooms} />
                                    </div>
                                )}
                                {activeTab === 'digital-id' && (
                                    <div className="max-w-md mx-auto mt-10 md:mt-20 h-96 pb-10">
                                        <DigitalID user={user} />
                                    </div>
                                )}
                                {activeTab === 'analytics' && (
                                    <div className="max-w-4xl mx-auto h-[400px] mt-10 pb-10">
                                        <Analytics />
                                    </div>
                                )}
                                {activeTab === 'feedback' && (
                                    <div className="h-full pb-10">
                                        <FeedbackView />
                                    </div>
                                )}
                            </div>

                            {/* Global Chatbot */}
                            <Chatbot user={user} />

                            {/* Global Booking Modal */}
                            <BookingModal 
                                isOpen={bookingModalOpen} 
                                room={selectedRoom} 
                                user={user}
                                onClose={() => setBookingModalOpen(false)}
                                onConfirm={handleBookingConfirm}
                            />

                            {/* User Profile Modal */}
                            <UserProfileModal 
                                user={user}
                                isOpen={profileOpen}
                                onClose={() => setProfileOpen(false)}
                                history={notifications}
                            />

                            {/* Loan Form Modal */}
                            <LoanFormModal 
                                user={user}
                                book={loanBook}
                                isOpen={loanModalOpen}
                                mode={loanMode}
                                onClose={() => setLoanModalOpen(false)}
                                onConfirm={handleLoanConfirm}
                            />
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>